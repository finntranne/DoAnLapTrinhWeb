<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/main :: layout(~{::title}, ~{::section})}">
<head>
    <title>Thanh Toán - AloTra</title>
</head>
<body>
<section>
    <nav class="breadcrumb-nav bg-light py-2">
        <div class="container">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a th:href="@{/}" class="text-decoration-none"><i class="fa-solid fa-home me-1"></i>Trang chủ</a></li>
                <li class="breadcrumb-item"><a th:href="@{/cart}" class="text-decoration-none"><i class="fa-solid fa-shopping-cart me-1"></i>Giỏ hàng</a></li>
                <li class="breadcrumb-item active" aria-current="page"><i class="fa-solid fa-credit-card me-1"></i>Thanh toán</li>
            </ol>
        </div>
    </nav>

    <div class="container my-5">
        <form th:action="@{/place-order}" method="POST" id="checkoutForm">
            <div class="row g-4">
                
                <div class="col-lg-7">
    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center"> <h5 class="mb-0 fw-bold">
                <i class="fa-solid fa-map-location-dot text-primary me-2"></i>
                Chọn địa chỉ giao hàng
            </h5>
            
            <a th:href="@{/user/addresses/new(origin='checkout')}" class="btn btn-sm btn-outline-primary">
                <i class="fa-solid fa-plus me-1"></i> Thêm địa chỉ mới
            </a>
            </div>
        <div class="card-body p-4" id="addressListContainer">
            <div th:if="${addresses == null or #lists.isEmpty(addresses)}" id="noAddressMessage">
                <p class="text-muted">Bạn chưa có địa chỉ nào.</p>
                </div>
            
            <div th:each="addr : ${addresses}" class="address-option form-check mb-3 p-3 border rounded-3">
                <input class="form-check-input mt-0" type="radio" name="addressId" 
                       th:id="'addr-' + ${addr.addressID}"
                       th:value="${addr.addressID}"
                       th:checked="${addr.isDefault()}" required>
                <label class="form-check-label w-100" th:for="'addr-' + ${addr.addressID}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-bold fs-6">
                            <span th:text="${addr.recipientName}"></span>
                            <span th:if="${addr.isDefault()}" class="badge bg-success ms-2">Mặc định</span>
                        </div>
                    </div>
                    <div class="text-muted small mt-1">
                        <span th:text="${addr.phoneNumber}"></span>
                        <span class="mx-2">|</span>
                        <span th:text="${addr.fullAddress}"></span>
                    </div>
                </label>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-header bg-white border-0 py-3">
            <h5 class="mb-0 fw-bold">
                <i class="fa-solid fa-pencil-alt text-primary me-2"></i>
                Ghi chú đơn hàng
            </h5>
        </div>
        <div class="card-body p-4">
            <textarea class="form-control" name="notes" rows="3" 
                      placeholder="Thêm hướng dẫn giao hàng..."></textarea>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-white border-0 py-3">
            <h5 class="mb-0 fw-bold">
                <i class="fa-solid fa-wallet text-primary me-2"></i>
                Phương thức thanh toán
            </h5>
        </div>
        <div class="card-body p-4">
            <div class="payment-option form-check mb-3 p-3 border rounded-3">
                <input class="form-check-input" type="radio" name="paymentMethod" 
                       id="payment_cash" value="Cash" checked>
                <label class="form-check-label fw-semibold" for="payment_cash">
                    <i class="fa-solid fa-money-bill-wave me-2 text-success"></i>
                    Tiền mặt (COD)
                </label>
            </div>
            
            <div class="payment-option form-check mb-3 p-3 border rounded-3">
                <input class="form-check-input" type="radio" name="paymentMethod" 
                       id="payment_vnpay" value="VNPay">
                <label class="form-check-label fw-semibold" for="payment_vnpay">
                    <i class="fa-solid fa-qrcode me-2 text-primary"></i>
                    VNPAY
                </label>
            </div>
        </div>
    </div>
</div>

                <div class="col-lg-5">
                    <div class="summary-card card shadow-sm border-0 rounded-3 position-sticky" style="top: 20px;">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-4">
                                <i class="fa-solid fa-receipt me-2"></i>Tóm tắt đơn hàng
                            </h5>

                            <div class="order-items-summary mb-3" style="max-height: 250px; overflow-y: auto;">
                                <div th:each="item : ${cartItems}" class="d-flex align-items-center mb-3">
                                    <img th:if="${item.variant.product.productImages != null and not #lists.isEmpty(item.variant.product.productImages)}"
                                         th:src="${item.variant.product.productImages[0].imageUrl}"
                                         class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                    <div class="flex-grow-1">
    <div class="fw-bold small" th:text="${item.variant.product.productName}"></div>
    <small class="text-white-50" th:text="'SL: ' + ${item.quantity} + ' - Size: ' + ${item.variant.size.sizeName}"></small>
    
    <div th:if="${not #lists.isEmpty(item.selectedToppings)}" class="mt-1">
        <small class="text-white-50" style="font-size: 0.8em;">
            <i class="fa-solid fa-plus-circle me-1 opacity-75"></i>
            <span th:text="${#strings.listJoin(item.selectedToppings.![toppingName], ', ')}"></span>
        </small>
    </div>
    </div>
                                    <div class="fw-semibold small"
                                         th:with="itemPrice=${item.variant.price}, 
                                                  toppingSum=${#aggregates.sum(item.selectedToppings.![additionalPrice])}, 
                                                  toppingPrice=${toppingSum ?: T(java.math.BigDecimal).ZERO}"
                                         th:text="${#numbers.formatDecimal((itemPrice + toppingPrice) * item.quantity, 0, 'POINT', 0, 'COMMA')} + 'đ'">
                                    </div>
                                </div>
                            </div>
                            
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                    <span class="text-white-50">Tạm tính</span>
                                    <span class="fw-semibold" th:text="${#numbers.formatDecimal(subtotal, 0, 'POINT', 0, 'COMMA')} + 'đ'"></span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                    <span class="text-white-50">Phí vận chuyển</span>
                                    <span class="fw-semibold" th:text="${#numbers.formatDecimal(shippingFee, 0, 'POINT', 0, 'COMMA')} + 'đ'"></span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-top border-white border-opacity-25">
                                    <span class="fs-5 fw-bold">Tổng cộng</span>
                                    <span class="price-highlight" th:text="${#numbers.formatDecimal(grandTotal, 0, 'POINT', 0, 'COMMA')} + 'đ'"></span>
                                </li>
                            </ul>

                            <div class="d-grid gap-3">
                                <button type="submit" class="btn btn-light btn-lg py-3 fw-bold">
                                    <i class="fa-solid fa-lock me-2"></i>
                                    Hoàn tất Đặt Hàng
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        </div>
</section>
</body>
</html>