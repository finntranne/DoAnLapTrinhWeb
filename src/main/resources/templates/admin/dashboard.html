<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layouts/admin-layout}" lang="vi">
<head>
<meta charset="UTF-8">
<title>Dashboard - Admin | AloTra</title>

<style>
/* CSS cho Stat Cards */
.stat-card {
	border-left: 5px solid; /* Dùng border left để tạo điểm nhấn */
	transition: transform 0.2s, box-shadow 0.3s;
	cursor: pointer;
	border-radius: 0.5rem;
}

.stat-card:hover {
	transform: translateY(-3px);
	box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.stat-icon-bg {
	font-size: 2rem;
	opacity: 0.6;
	padding: 0.5rem;
	border-radius: 50%;
	width: 50px;
	height: 50px;
	display: flex;
	align-items: center;
	justify-content: center;
}
/* Màu sắc cụ thể cho border left của từng card */
.card-revenue {
	border-color: #007bff !important;
}

.card-users {
	border-color: #28a745 !important;
}

.card-orders {
	border-color: #ffc107 !important;
}

.card-profit {
	border-color: #dc3545 !important;
}
</style>
</head>
<body>

	<div layout:fragment="content">

		<div
			class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
			<h1 class="h2  fw-bold text-primary">
				<i class="bi bi-speedometer2 me-2"></i> Trang chủ Admin
			</h1>
		</div>

		<div class="wrapper">

			<div class="content-wrapper p-0">
				<section class="content">
					<div class="container-fluid">

						<div class="row mb-4">

							<div class="col-lg-3 col-md-6 mb-3">
								<div class="card stat-card card-revenue shadow-sm">
									<div
										class="card-body d-flex justify-content-between align-items-center p-3">
										<div>
											<h5 class="mb-0 fw-bold"
												th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' đ'">
												0 đ
											</h5>
											<p class="text-muted mb-0">TỔNG DOANH THU</p>
										</div>
										<div class="stat-icon-bg text-primary bg-primary-subtle">
											<i class="bi bi-currency-dollar"></i>
										</div>
									</div>
									<div class="card-footer p-1 bg-light border-0">
										<small class="ms-2"
											th:classappend="${revenueChangeRate >= 0} ? 'text-success' : 'text-danger'">

											<i th:if="${revenueChangeRate >= 0}"
											class="bi bi-caret-up-fill me-1"></i> <i
											th:if="${revenueChangeRate < 0}"
											class="bi bi-caret-down-fill me-1"></i> <span
											th:text="${#numbers.formatPercent(T(java.lang.Math).abs(revenueChangeRate), 0, 0)}">0%</span>
											so với tháng trước
										</small>
									</div>
								</div>
							</div>

							<div class="col-lg-3 col-md-6 mb-3">
								<div class="card stat-card card-users shadow-sm">
									<div
										class="card-body d-flex justify-content-between align-items-center p-3">
										<div>
											<h5 class="mb-0 fw-bold"
												th:text="${#numbers.formatInteger(totalNewUsers, 0, 'COMMA')}">0
											</h5>
											<p class="text-muted mb-0">NGƯỜI DÙNG MỚI</p>
										</div>
										<div class="stat-icon-bg text-success bg-success-subtle">
											<i class="bi bi-person-plus-fill"></i>
										</div>
									</div>
									<div class="card-footer p-1 bg-light border-0">
										<small class="ms-2"
											th:classappend="${userChangeRate >= 0} ? 'text-success' : 'text-danger'">

											<i th:if="${userChangeRate >= 0}"
											class="bi bi-caret-up-fill me-1"></i> <i
											th:if="${userChangeRate < 0}"
											class="bi bi-caret-down-fill me-1"></i> <span
											th:text="${#numbers.formatPercent(T(java.lang.Math).abs(userChangeRate), 0, 0)}">0%</span>
											so với tháng trước
										</small>
									</div>
								</div>
							</div>

							<div class="col-lg-3 col-md-6 mb-3">
								<div class="card stat-card card-orders shadow-sm">
									<div
										class="card-body d-flex justify-content-between align-items-center p-3">
										<div>
											<h5 class="mb-0 fw-bold"
												th:text="${#numbers.formatInteger(totalOrders, 0, 'COMMA')}">0</h5>
											<p class="text-muted mb-0">ĐƠN HÀNG</p>
										</div>
										<div class="stat-icon-bg text-warning bg-warning-subtle">
											<i class="bi bi-cart4"></i>
										</div>
									</div>
									<div class="card-footer p-1 bg-light border-0">
										<small class="ms-2"
											th:classappend="${orderChangeRate >= 0} ? 'text-success' : 'text-danger'">

											<i th:if="${orderChangeRate >= 0}"
											class="bi bi-caret-up-fill me-1"></i> <i
											th:if="${orderChangeRate < 0}"
											class="bi bi-caret-down-fill me-1"></i> <span
											th:text="${#numbers.formatPercent(T(java.lang.Math).abs(orderChangeRate), 0, 0)}">0%</span>
											so với tháng trước
										</small>
									</div>
								</div>
							</div>

							<div class="col-lg-3 col-md-6 mb-3">
								<div class="card stat-card card-profit shadow-sm">
									<div
										class="card-body d-flex justify-content-between align-items-center p-3">
										<div>
											<h5 class="mb-0 fw-bold"
												th:text="${#numbers.formatDecimal(totalProfit, 0, 'COMMA', 0, 'POINT')} + ' đ'">
												0 đ
											</h5>
											<p class="text-muted mb-0">TỔNG LỢI NHUẬN</p>
										</div>
										<div class="stat-icon-bg text-danger bg-danger-subtle">
											<i class="bi bi-graph-up-arrow"></i>
										</div>
									</div>
									<div class="card-footer p-1 bg-light border-0">
										<small class="ms-2"
											th:classappend="${profitChangeRate >= 0} ? 'text-success' : 'text-danger'">

											<i th:if="${profitChangeRate >= 0}"
											class="bi bi-caret-up-fill me-1"></i> <i
											th:if="${profitChangeRate < 0}"
											class="bi bi-caret-down-fill me-1"></i> <span
											th:text="${#numbers.formatPercent(T(java.lang.Math).abs(profitChangeRate), 0, 0)}">0%</span>
											so với tháng trước
										</small>
									</div>
								</div>
							</div>

						</div>

						<div class="row">
							
							<div class="col-md-7">
								<div class="card mb-4 shadow-sm">
									<div class="card-header bg-white">
										<h5 class="card-title mb-0">Biểu đồ Doanh số (7 tháng gần nhất)</h5>
									</div>
									<div class="card-body">
										<div id="sales-chart-container" style="height: 350px;">
											<canvas id="salesChart"></canvas>
										</div>
									</div>
								</div>
							</div>

							<div class="col-md-5">
								<div class="card mb-4 shadow-sm">
									<div class="card-header bg-white">
										<h5 class="card-title mb-0">Top Cửa Hàng (Doanh Thu Tháng Này)</h5>
									</div>
									<div class="card-body">
										<div id="shop-ranking-chart-container" style="height: 350px;">
											<canvas id="shopRankingChart"></canvas>
										</div>
									</div>
								</div>
							</div>
						</div>
						</div>
				</section>
			</div>


		</div>
	</div>
</body>
<th:block layout:fragment="scripts">


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
		// Dùng dữ liệu thật từ Backend (thay thế biến mẫu)
		const monthlyLabels = /*[[${monthlyLabels}]]*/ ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7"];
		
		// Chuyển đổi List<BigDecimal> thành mảng Number
		const monthlySalesData = /*[[${monthlySalesData}]]*/ [0, 0, 0, 0, 0, 0, 0];
		const parsedMonthlySalesData = monthlySalesData.map(item => parseFloat(item));
		
    /*[# th:if="${shopRanking != null and !#lists.isEmpty(shopRanking)}"]*/
        // Dữ liệu Shop Ranking được truyền dưới dạng List<Object[]>
        const shopRankingArray = /*[[${shopRanking}]]*/ [];
        
        // Ánh xạ (Map) mảng Object[]: item[0]=Tên Shop (String), item[1]=Doanh thu (BigDecimal/String)
        shopNames = shopRankingArray.map(item => String(item[0]));
        // Chuyển đổi giá trị doanh thu từ String (BigDecimal) sang Number
        shopRevenues = shopRankingArray.map(item => parseFloat(item[1]));
    /*[/]*/
    
    /*[# th:unless="${shopRanking != null and !#lists.isEmpty(shopRanking)}"]*/
        // Thiết lập giá trị mặc định nếu không có dữ liệu để tránh lỗi JS
        const shopNames = [];
        const shopRevenues = [];
    /*[/]*/


    // =========================================================================
    // 1. SALES CHART (BIỂU ĐỒ DOANH SỐ)
    // =========================================================================
    // Sử dụng `document.getElementById` an toàn hơn
    const ctxSales = document.getElementById('salesChart') ? document.getElementById('salesChart').getContext('2d') : null;

    if (ctxSales) {
        new Chart(ctxSales, {
            type: "line",
            data: {
                labels: monthlyLabels, // Dùng dữ liệu thật
                datasets: [
                    {
                        label: "Doanh số (đ)",
                        data: parsedMonthlySalesData, // Dùng dữ liệu thật đã parse
                        borderColor: "#007bff",
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                // Định dạng tiền tệ VNĐ
                                label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed.y);
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            // Định dạng trục Y thành đơn vị tiền tệ ngắn gọn
                            callback: (v) => new Intl.NumberFormat('vi-VN', { notation: 'compact', compactDisplay: 'short' }).format(v),
                        },
                        grid: { drawBorder: false }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
            },
        });
    }

    // =========================================================================
    // 2. SHOP RANKING CHART (BIỂU ĐỒ XẾP HẠNG SHOP)
    // =========================================================================
    // Biểu đồ này chỉ vẽ nếu có dữ liệu
    const ctxRanking = document.getElementById('shopRankingChart') ? document.getElementById('shopRankingChart').getContext('2d') : null;
    
    if (ctxRanking && shopNames.length > 0) {
        new Chart(ctxRanking, {
            type: 'bar',
            data: {
                labels: shopNames,
                datasets: [{
                    label: 'Doanh Thu (đ)',
                    data: shopRevenues,
                    backgroundColor: 'rgba(255, 159, 64, 0.7)', // Màu cam
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Biểu đồ thanh ngang
                plugins: {
                    legend: { display: false },
                    title: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                // Định dạng tiền tệ VNĐ
                                label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed.x);
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Doanh Thu' },
                        ticks: {
                            callback: function(value, index, values) {
                               return new Intl.NumberFormat('vi-VN', { 
                                   notation: 'compact', 
                                   compactDisplay: 'short' 
                               }).format(value);
                            }
                        }
                    },
                    y: {
                        // Đảm bảo tên Shop không bị cắt nếu quá dài
                        autoSkip: false 
                    }
                }
            }
        });
    } else if (document.getElementById('shop-ranking-chart-container')) {
        // Hiển thị thông báo nếu không có dữ liệu
        document.getElementById('shop-ranking-chart-container').innerHTML = "<p class='text-center text-muted mt-5'>Chưa có đủ dữ liệu để xếp hạng cửa hàng.</p>";
    }
</script>
</th:block>
</html>