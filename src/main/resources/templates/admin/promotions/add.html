<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layouts/admin-layout.html}">

<head>
<title>Th√™m Khuy·∫øn M√£i</title>
</head>

<body>
	<main class="app-main">
		<div layout:fragment="content">
			<div class="container">
				<!-- Header -->
				<div class="d-flex justify-content-between align-items-center mb-4">
					<h2 class="mb-0">
						<i class="bi bi-gift-fill me-2"></i>Th√™m Khuy·∫øn M√£i M·ªõi
					</h2>
					<a th:href="@{/admin/promotions}" class="btn btn-outline-secondary">
						<i class="bi bi-arrow-left me-1"></i>Quay l·∫°i
					</a>
				</div>

				<!-- Error Message -->
				<div th:if="${errorMessage}"
					class="alert alert-danger alert-dismissible fade show" role="alert">
					<i class="bi bi-exclamation-triangle-fill me-2"></i> <span
						th:text="${errorMessage}"></span>
					<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				</div>

				<!-- Form -->
				<form th:action="@{/admin/promotions/save}" th:object="${promotion}"
					method="post">

					<!-- Th√¥ng tin c∆° b·∫£n -->
					<div class="card shadow-sm mb-4">
						<div class="card-header bg-light">
							<h5 class="mb-0">
								<i class="bi bi-info-circle me-2"></i>Th√¥ng tin c∆° b·∫£n
							</h5>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6 mb-3">
									<label class="form-label fw-semibold"> T√™n khuy·∫øn m√£i <span
										class="text-danger">*</span>
									</label> <input type="text" class="form-control"
										th:field="*{promotionName}"
										placeholder="VD: Gi·∫£m gi√° Black Friday" required>
								</div>
								<div class="col-md-6 mb-3">
									<label class="form-label fw-semibold"> M√£ khuy·∫øn m√£i <span
										class="text-danger">*</span>
									</label> <input type="text" class="form-control"
										th:field="*{promoCode}" placeholder="VD: BLACKFRIDAY2024"
										required> <small class="text-muted">M√£ ph·∫£i l√†
										duy nh·∫•t, vi·∫øt hoa kh√¥ng d·∫•u</small>
								</div>
							</div>

							<div class="mb-3">
								<label class="form-label fw-semibold">M√¥ t·∫£</label>
								<textarea class="form-control" th:field="*{description}"
									rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ khuy·∫øn m√£i..."></textarea>
							</div>

							<div class="row">
								<div class="col-md-6 mb-3">
									<label class="form-label fw-semibold"> Lo·∫°i khuy·∫øn m√£i
										<span class="text-danger">*</span>
									</label> <select class="form-select" th:field="*{promotionType}"
										required>
										<option value="">-- Ch·ªçn lo·∫°i --</option>
										<option value="ORDER">√Åp d·ª•ng cho ƒë∆°n h√†ng</option>
										<option value="PRODUCT">√Åp d·ª•ng cho s·∫£n ph·∫©m</option>
									</select>
								</div>
							</div>
						</div>
					</div>

					<!-- Thi·∫øt l·∫≠p gi·∫£m gi√° -->
					<div class="card shadow-sm mb-4">
						<div class="card-header bg-light">
							<h5 class="mb-0">
								<i class="bi bi-percent me-2"></i>Thi·∫øt l·∫≠p gi·∫£m gi√°
							</h5>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-4 mb-3">
									<label class="form-label fw-semibold"> Lo·∫°i gi·∫£m gi√° <span
										class="text-danger">*</span>
									</label> <select class="form-select" th:field="*{discountType}"
										id="discountType" required>
										<option value="">-- Ch·ªçn lo·∫°i --</option>
										<option value="Percentage">Ph·∫ßn trƒÉm (%)</option>
										<option value="FixedAmount">S·ªë ti·ªÅn c·ªë ƒë·ªãnh (VND)</option>
										<option value="FreeShip">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</option>
									</select>
								</div>
								<div class="col-md-4 mb-3">
									<label class="form-label fw-semibold"> Gi√° tr·ªã gi·∫£m <span
										class="text-danger">*</span>
									</label> <input type="number" class="form-control"
										th:field="*{discountValue}" id="discountValue" step="0.01"
										placeholder="Nh·∫≠p gi√° tr·ªã" required> <small
										class="text-muted" id="discountHint">VD: 15 (cho 15%)
										ho·∫∑c 50000 (cho 50k)</small>
								</div>
								<div class="col-md-4 mb-3">
									<label class="form-label fw-semibold">Gi·∫£m t·ªëi ƒëa</label> <input
										type="number" class="form-control"
										th:field="*{maxDiscountAmount}" step="1000"
										placeholder="VD: 100000"> <small class="text-muted">Ch·ªâ
										√°p d·ª•ng cho gi·∫£m theo %</small>
								</div>
							</div>

							<div class="row">
								<div class="col-md-6 mb-3">
									<label class="form-label fw-semibold">ƒê∆°n h√†ng t·ªëi
										thi·ªÉu</label> <input type="number" class="form-control"
										th:field="*{minOrderValue}" step="1000"
										placeholder="VD: 500000"> <small class="text-muted">ƒê·ªÉ
										tr·ªëng n·∫øu kh√¥ng y√™u c·∫ßu t·ªëi thi·ªÉu</small>
								</div>
								<div class="col-md-6 mb-3">
									<label class="form-label fw-semibold">Gi·ªõi h·∫°n s·ªë l∆∞·ª£t
										s·ª≠ d·ª•ng</label> <input type="number" class="form-control"
										th:field="*{usageLimit}" placeholder="VD: 100"> <small
										class="text-muted">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng gi·ªõi h·∫°n</small>
								</div>
							</div>
						</div>
					</div>

					<!-- Th·ªùi gian √°p d·ª•ng -->
					<div class="card shadow-sm mb-4">
						<div class="card-header bg-light">
							<h5 class="mb-0">
								<i class="bi bi-calendar-range me-2"></i>Th·ªùi gian √°p d·ª•ng
							</h5>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6 mb-3">
									<label class="form-label fw-semibold"> Ng√†y b·∫Øt ƒë·∫ßu <span
										class="text-danger">*</span>
									</label> <input type="datetime-local" class="form-control"
										th:field="*{startDate}" required>
								</div>
								<div class="col-md-6 mb-3">
									<label class="form-label fw-semibold"> Ng√†y k·∫øt th√∫c <span
										class="text-danger">*</span>
									</label> <input type="datetime-local" class="form-control"
										th:field="*{endDate}" required>
								</div>
							</div>
						</div>
					</div>

					<!-- Ph·∫°m vi √°p d·ª•ng -->
					<div class="card shadow-sm mb-4">
						<div class="card-header bg-light">
							<h5 class="mb-0">
								<i class="bi bi-geo-alt me-2"></i>Ph·∫°m vi √°p d·ª•ng
							</h5>
						</div>
						<div class="card-body">
							<!-- N·∫øu promotionType = ORDER -->
							<div id="orderPromotionScope" style="display: none;">
								<div class="alert alert-info">
									<i class="bi bi-info-circle me-2"></i> <small>Khuy·∫øn
										m√£i ƒë∆°n h√†ng - B·ªè tr·ªëng ƒë·ªÉ √°p d·ª•ng cho <strong>to√†n
											s√†n</strong>
									</small>
								</div>

								<div class="mb-3">
									<label class="form-label fw-semibold"> <i
										class="bi bi-shop me-1"></i>√Åp d·ª•ng cho c·ª≠a h√†ng (t√πy ch·ªçn)
									</label> <select class="form-select" name="applicableShopIds" multiple
										size="6" id="shopSelect">
										<option th:each="shop : ${allShops}" th:value="${shop.shopId}"
											th:text="${shop.shopName}"></option>
									</select> <small class="text-muted">Gi·ªØ Ctrl (ho·∫∑c Cmd) ƒë·ªÉ ch·ªçn
										nhi·ªÅu. B·ªè tr·ªëng = To√†n s√†n</small>
								</div>
							</div>

							<!-- N·∫øu promotionType = PRODUCT -->
							<div id="productPromotionScope" style="display: none;">
								<div class="alert alert-warning">
									<i class="bi bi-exclamation-triangle me-2"></i> <small>Khuy·∫øn
										m√£i s·∫£n ph·∫©m - <strong>B·∫Øt bu·ªôc ch·ªçn √≠t nh·∫•t 1 s·∫£n
											ph·∫©m</strong>
									</small>
								</div>

								<div class="mb-3">
									<label class="form-label fw-semibold"> <i
										class="bi bi-box-seam me-1"></i>Ch·ªçn s·∫£n ph·∫©m √°p d·ª•ng <span
										class="text-danger">*</span>
									</label> <input type="text" class="form-control mb-2"
										id="productSearch" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m...">
									<select class="form-select" name="applicableProductIds"
										multiple size="8" id="productSelect" required>
										<option th:each="product : ${allProducts}"
											th:value="${product.productID}"
											th:text="${product.productName}"></option>
									</select> <small class="text-muted">ƒê√£ ch·ªçn: <span
										id="selectedCount">0</span> s·∫£n ph·∫©m
									</small>
								</div>
							</div>

							<!-- Ch∆∞a ch·ªçn type -->
							<div id="noTypeSelected">
								<div class="alert alert-secondary">
									<i class="bi bi-arrow-up-circle me-2"></i> Vui l√≤ng ch·ªçn <strong>Lo·∫°i
										khuy·∫øn m√£i</strong> ·ªü tr√™n ƒë·ªÉ hi·ªÉn th·ªã ph·∫°m vi √°p d·ª•ng
								</div>
							</div>
						</div>
					</div>

					<!-- Action Buttons -->
					<div class="card shadow-sm">
						<div class="card-body">
							<div class="d-flex justify-content-end gap-2">
								<a th:href="@{/admin/promotions}"
									class="btn btn-outline-secondary"> <i
									class="bi bi-x-circle me-1"></i>H·ªßy
								</a>
								<button type="submit" class="btn btn-success">
									<i class="bi bi-check-circle me-1"></i>T·∫°o khuy·∫øn m√£i
								</button>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</main>
</body>

<th:block layout:fragment="scripts">
    <script>
        // X·ª≠ l√Ω hi·ªÉn th·ªã ph·∫°m vi theo promotionType
        document.getElementById('promotionType')?.addEventListener('change', function() {
            const orderScope = document.getElementById('orderPromotionScope');
            const productScope = document.getElementById('productPromotionScope');
            const noTypeDiv = document.getElementById('noTypeSelected');
            const productSelect = document.getElementById('productSelect');
            const shopSelect = document.getElementById('shopSelect');

            // ·∫®n t·∫•t c·∫£
            orderScope.style.display = 'none';
            productScope.style.display = 'none';
            noTypeDiv.style.display = 'none';

            // Reset required
            if (productSelect) productSelect.removeAttribute('required');
            if (shopSelect) shopSelect.removeAttribute('required');

            if (this.value === 'ORDER') {
                orderScope.style.display = 'block';
            } else if (this.value === 'PRODUCT') {
                productScope.style.display = 'block';
                if (productSelect) productSelect.setAttribute('required', 'required');
            } else {
                noTypeDiv.style.display = 'block';
            }
        });

        // Search s·∫£n ph·∫©m
        document.getElementById('productSearch')?.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            const options = document.querySelectorAll('#productSelect option');
            
            options.forEach(option => {
                const text = option.text.toLowerCase();
                option.style.display = text.includes(filter) ? '' : 'none';
            });
        });

        // ƒê·∫øm s·∫£n ph·∫©m ƒë√£ ch·ªçn
        document.getElementById('productSelect')?.addEventListener('change', function() {
            const count = this.selectedOptions.length;
            document.getElementById('selectedCount').textContent = count;
        });

        // Validate form
        document.querySelector('form')?.addEventListener('submit', function(e) {
            const promotionType = document.querySelector('select[name="promotionType"]').value;
            
            if (promotionType === 'PRODUCT') {
                const selectedProducts = document.querySelectorAll('#productSelect option:checked');
                if (selectedProducts.length === 0) {
                    e.preventDefault();
                    alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m cho khuy·∫øn m√£i PRODUCT!');
                    return false;
                }
            }

            // Validate ng√†y
            const startDate = new Date(document.querySelector('input[name="startDate"]').value);
            const endDate = new Date(document.querySelector('input[name="endDate"]').value);
            
            if (endDate <= startDate) {
                e.preventDefault();
                alert('Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu!');
                return false;
            }
        });

        // Trigger khi load trang (cho tr∆∞·ªùng h·ª£p edit)
        document.addEventListener('DOMContentLoaded', function() {
            const promotionType = document.getElementById('promotionType');
            if (promotionType && promotionType.value) {
                promotionType.dispatchEvent(new Event('change'));
            }
        });
    </script>
</th:block>
</html>