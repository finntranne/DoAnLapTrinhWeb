<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout.html}">

<head>
<title>Quản lý sản phẩm</title>
</head>

<body>
	<main class="app-main">
		<div layout:fragment="content">
			<div class="container mt-4">

				<div class="d-flex justify-content-between align-items-center mb-3">
					<h3 class="fw-bold mb-0">Danh sách sản phẩm</h3>
				</div>

				<div class="card shadow-sm border-0 mb-4">
					<div class="card-body">
						<form th:action="@{/admin/products/search}" method="get">
							<div class="row g-3 align-items-end">
								<div class="col-md-3">
									<label class="form-label small fw-semibold text-muted">
										<i class="bi bi-box-seam me-1"></i>Tên sản phẩm
									</label> <input type="text" name="productName"
										th:value="${productName}" class="form-control form-control-sm"
										placeholder="Nhập tên sản phẩm...">
								</div>
								<div class="col-md-2">
									<label class="form-label small fw-semibold text-muted">
										<i class="bi bi-tag-fill me-1"></i>Danh mục
									</label> <input type="text" name="categoryName"
										th:value="${categoryName}"
										class="form-control form-control-sm" placeholder="Danh mục...">
								</div>
								<div class="col-md-2">
									<label class="form-label small fw-semibold text-muted">
										<i class="bi bi-shop me-1"></i>Cửa hàng
									</label> <input type="text" name="shopName" th:value="${shopName}"
										class="form-control form-control-sm" placeholder="Tên shop...">
								</div>
								<div class="col-md-2">
									<label class="form-label small fw-semibold text-muted">
										<i class="bi bi-flag-fill me-1"></i>Trạng thái
									</label> <select name="status" class="form-select form-select-sm"
										th:value="${status}">
										<option value="">Tất cả</option>
										<option value="0" th:selected="${status == '0'}">Chờ
											duyệt</option>
										<option value="1" th:selected="${status == '1'}">Đã
											duyệt</option>
										<option value="2" th:selected="${status == '2'}">Từ
											chối</option>
									</select>
								</div>
								<div class="col-md-3 d-flex gap-2">
									<button type="submit"
										class="btn btn-success btn-sm flex-fill rounded-pill">
										<i class="bi bi-search me-1"></i>Tìm kiếm
									</button>
									<button type="button" onclick="clearFilters()"
										class="btn btn-outline-secondary btn-sm rounded-pill">
										<i class="bi bi-x-circle"></i>
									</button>
								</div>
							</div>
						</form>
					</div>
				</div>



				<div class="table-responsive shadow-sm rounded">
					<table class="table table-striped table-hover align-middle">
						<thead class="table-success">
							<tr>
								<th scope="col"><input type="checkbox" id="selectAll"
									class="form-check-input"></th>
								<th scope="col">STT</th>
								<th scope="col">Tên sản phẩm</th>
								<th scope="col">Shop</th>

								<th scope="col">Trạng thái</th>
								<th scope="col">Hành động</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="product, iterStat : ${products}">

								<td><input type="checkbox" name="selectedIds"
									th:value="${product.productId}"
									class="form-check-input selectItem"></td>
								<td th:text="${iterStat.index + 1}"></td>
								<td>
									<div>
										<div class="fw-semibold" th:text="${product.productName}"></div>
										<span class="product-category"> <i
											class="bi bi-tag-fill me-1"></i> <span
											th:text="${product.category.categoryName}"></span>
										</span>
									</div>
								</td>

								<td><a class="text-decoration-none "> <span
										th:text="${product.shop.shopName}"></span>
								</a></td>

								<td><span class="badge rounded-pill fw-semibold px-3 py-2"
									th:classappend="${product.status == 0 ? 'bg-warning-subtle text-warning border border-warning-subtle' :
                                                      (product.status == 1 ? 'bg-success-subtle text-success border border-success-subtle' :
                                                      'bg-danger-subtle text-danger border border-danger-subtle')}">
										<i
										th:class="${product.status == 0 ? 'bi bi-hourglass-split' :
                                                 (product.status == 1 ? 'bi bi-check-circle-fill' : 'bi bi-x-circle-fill')}"></i>
										<span
										th:text="${product.status == 0 ? 'Chờ duyệt' : (product.status == 1 ? 'Đã duyệt' : 'Bị từ chối')}"></span>
								</span></td>

								<td>
									<div class="d-flex gap-2 justify-content-start">
										<a
											th:href="@{'/admin/products/detail/' + ${product.productId}}"
											class="btn btn-outline-info btn-sm rounded-pill"> <i
											class="bi bi-eye"></i> Xem
										</a> <a
											th:href="@{'/admin/products/approve/' + ${product.productId}}"
											class="btn btn-outline-success btn-sm rounded-pill"
											th:classappend="${product.status == 1} ? ' disabled no-click' : ''"
											th:attr="data-bs-toggle=${product.status == 1 ? 'tooltip' : null},
									                data-bs-title=${product.status == 1 ? 'Sản phẩm đã được duyệt' : null}">
											<i class="bi bi-check-circle"></i> Duyệt
										</a>

										<!-- Từ chối -->
										<a
											th:href="@{'/admin/products/reject/' + ${product.productId}}"
											class="btn btn-outline-danger btn-sm rounded-pill"
											th:classappend="${product.status != 0} ? ' disabled no-click' : ''"
											th:attr="data-bs-toggle=${product.status != 0 ? 'tooltip' : null},
									                data-bs-title=${product.status != 0 ? 'Chỉ có thể từ chối sản phẩm đang chờ duyệt' : null}">
											<i class="bi bi-x-circle"></i> Từ chối
										</a>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>

				<nav th:if="${totalPages > 1}" class="mt-4">
					<ul class="pagination justify-content-center flex-wrap">
						<li class="page-item"
							th:classappend="${currentPage == 1} ? 'disabled'"><a
							class="page-link rounded-pill shadow-sm border-0"
							th:href="@{'/admin/products?page=' + ${currentPage - 1}}"> <i
								class="bi bi-chevron-double-left"></i>
						</a></li>

						<li class="page-item" th:if="${currentPage > 3}"><a
							class="page-link rounded-pill shadow-sm border-0"
							th:href="@{'/admin/products?page=1'}">1</a></li>

						<li class="page-item disabled" th:if="${currentPage > 4}"><span
							class="page-link border-0 bg-transparent">...</span></li>

						<li class="page-item mx-1"
							th:each="page : ${#numbers.sequence(currentPage - 1, currentPage + 1)}"
							th:if="${page >= 1 and page <= totalPages}"
							th:classappend="${page == currentPage} ? 'active'"><a
							class="page-link rounded-pill shadow-sm border-0 fw-semibold"
							th:href="@{'/admin/products?page=' + ${page}}" th:text="${page}"></a>
						</li>

						<li class="page-item disabled"
							th:if="${currentPage < totalPages - 3}"><span
							class="page-link border-0 bg-transparent">...</span></li>

						<li class="page-item" th:if="${currentPage < totalPages - 2}">
							<a class="page-link rounded-pill shadow-sm border-0"
							th:href="@{'/admin/products?page=' + ${totalPages}}"
							th:text="${totalPages}"></a>
						</li>

						<li class="page-item"
							th:classappend="${currentPage == totalPages} ? 'disabled'">
							<a class="page-link rounded-pill shadow-sm border-0"
							th:href="@{'/admin/products?page=' + ${currentPage + 1}}"> <i
								class="bi bi-chevron-double-right"></i>
						</a>
						</li>
					</ul>
				</nav>
			</div>
		</div>
	</main>

	<th:block layout:fragment="scripts">
		<script>
        document.addEventListener("DOMContentLoaded", function () {
        	const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        	tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
        	  
        	  
            const selectAll = document.getElementById("selectAll");
            const checkboxes = document.querySelectorAll(".selectItem");

            if (selectAll && checkboxes.length > 0) {
                // 1. Khi click vào checkbox "Chọn tất cả"
                selectAll.addEventListener("change", function () {
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });
                });

                // 2. Lắng nghe sự kiện trên từng checkbox con
                checkboxes.forEach(cb => {
                    cb.addEventListener("change", function () {
                        // Kiểm tra xem tất cả các checkbox con có được chọn hay không
                        const allChecked = Array.from(checkboxes).every(item => item.checked);
                        // Cập nhật lại trạng thái của checkbox "Chọn tất cả"
                        selectAll.checked = allChecked;
                    });
                });
            }
        });
        
        function clearFilters() {
        	document.querySelector('input[name="productName"]').value = '';
        	document.querySelector('input[name="categoryName"]').value = '';
        	document.querySelector('input[name="shopName"]').value = '';
        	document.querySelector('select[name="status"]').value = '';
        	
        	// Redirect to products page without filters
        	window.location.href = '/admin/products';
        }
    </script>
	</th:block>

</body>
</html>
