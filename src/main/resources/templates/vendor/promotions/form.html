<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{vendor/layouts/vendor-layout}" lang="vi">
<head>
<meta charset="UTF-8">
<title th:text="${action == 'create' ? 'Tạo khuyến mãi mới' : 'Chỉnh sửa khuyến mãi'} + ' - Vendor | AloTra'"></title>
<style>
.form-label.required::after {
	content: " *";
	color: red;
}
</style>
</head>
<body>

	<div layout:fragment="content">

		<div
			class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
			<h1 class="h2">
				<i class="bi bi-gift"></i>
				<span th:text="${action == 'create' ? 'Tạo khuyến mãi mới' : 'Chỉnh sửa khuyến mãi'}"></span>
			</h1>
			<a href="/vendor/promotions" class="btn btn-outline-secondary">
				<i class="bi bi-arrow-left"></i> Quay lại
			</a>
		</div>

		<!-- Alerts -->
		<div th:if="${error}"
			class="alert alert-danger alert-dismissible fade show" role="alert">
			<i class="bi bi-exclamation-triangle"></i>
			<span th:text="${error}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"
				aria-label="Close"></button>
		</div>

		<!-- Form -->
		<form
			th:action="${action == 'create' ? '/vendor/promotions/create' : '/vendor/promotions/edit/' + promotionId}"
			method="post" th:object="${promotion}" id="promotionForm">

			<input type="hidden" name="${_csrf.parameterName}"
				value="${_csrf.token}" />

			<div class="row">
				<div class="col-lg-8">
					<!-- Thông tin cơ bản -->
					<div class="card mb-4">
						<div class="card-header">
							<h5 class="mb-0">
								<i class="bi bi-info-circle me-2"></i>Thông tin cơ bản
							</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								<div class="col-md-8">
									<label for="promotionName" class="form-label required">Tên
										khuyến mãi</label> 
									<input type="text" class="form-control"
										id="promotionName" th:field="*{promotionName}"
										placeholder="VD: Giảm giá mùa hè" required>
									<div class="form-text">Tên hiển thị của chương trình
										khuyến mãi</div>
								</div>

								<div class="col-md-4">
									<label for="promoCode" class="form-label required">Mã
										giảm giá</label> 
									<input type="text"
										class="form-control text-uppercase" id="promoCode"
										th:field="*{promoCode}" placeholder="VD: SUMMER2025"
										maxlength="20" required style="font-family: monospace;">
									<div class="form-text">Mã khách hàng nhập khi đặt hàng</div>
								</div>

								<div class="col-12">
									<label for="description" class="form-label required">Mô
										tả</label>
									<textarea class="form-control" id="description"
										th:field="*{description}" rows="3"
										placeholder="Mô tả chi tiết về chương trình khuyến mãi..."
										required></textarea>
								</div>
							</div>
						</div>
					</div>

					<!-- Cài đặt giảm giá -->
					<div class="card mb-4">
						<div class="card-header">
							<h5 class="mb-0">
								<i class="bi bi-percent me-2"></i>Cài đặt giảm giá
							</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								<div class="col-md-6">
									<label for="discountType" class="form-label required">Loại
										giảm giá</label> 
									<select class="form-select" id="discountType"
										th:field="*{discountType}" onchange="toggleDiscountFields()"
										required>
										<option value="">-- Chọn loại --</option>
										<option value="PERCENTAGE">Giảm theo phần trăm (%)</option>
										<option value="FIXED">Giảm cố định (VNĐ)</option>
									</select>
								</div>

								<div class="col-md-6">
									<label for="discountValue" class="form-label required">Giá
										trị giảm</label>
									<div class="input-group">
										<input type="number" class="form-control" id="discountValue"
											th:field="*{discountValue}" placeholder="0" step="0.01"
											min="0" required> 
										<span class="input-group-text" id="discountValueUnit">%</span>
									</div>
									<div class="form-text" id="discountValueHelp">Nhập giá
										trị giảm giá</div>
								</div>

								<div class="col-md-6" id="maxDiscountField">
									<label for="maxDiscountAmount" class="form-label">Giảm
										tối đa</label>
									<div class="input-group">
										<input type="number" class="form-control"
											id="maxDiscountAmount" th:field="*{maxDiscountAmount}"
											placeholder="0" step="1000" min="0"> 
										<span class="input-group-text">VNĐ</span>
									</div>
									<div class="form-text">Số tiền giảm tối đa (chỉ với giảm %)</div>
								</div>

								<div class="col-md-6">
									<label for="minOrderValue" class="form-label required">Giá
										trị đơn hàng tối thiểu</label>
									<div class="input-group">
										<input type="number" class="form-control" id="minOrderValue"
											th:field="*{minOrderValue}" placeholder="0" step="1000"
											min="0" required> 
										<span class="input-group-text">VNĐ</span>
									</div>
									<div class="form-text">Giá trị đơn hàng tối thiểu để áp dụng</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Thời gian áp dụng -->
					<div class="card mb-4">
						<div class="card-header">
							<h5 class="mb-0">
								<i class="bi bi-calendar-range me-2"></i>Thời gian áp dụng
							</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								<div class="col-md-6">
									<label for="startDate" class="form-label required">Ngày
										bắt đầu</label> 
									<input type="datetime-local" class="form-control"
										id="startDate" 
										name="startDate"
										th:value="${formattedStartDate != null ? formattedStartDate : (promotion.startDate != null ? promotion.startDate : '')}"
										required>
								</div>

								<div class="col-md-6">
									<label for="endDate" class="form-label required">Ngày
										kết thúc</label> 
									<input type="datetime-local" class="form-control"
										id="endDate"
										name="endDate" 
										th:value="${formattedEndDate != null ? formattedEndDate : (promotion.endDate != null ? promotion.endDate : '')}"
										required>
								</div>
							</div>
						</div>
					</div>

					<!-- Giới hạn sử dụng -->
					<div class="card mb-4">
						<div class="card-header">
							<h5 class="mb-0">
								<i class="bi bi-123 me-2"></i>Giới hạn sử dụng
							</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								<div class="col-md-12">
									<div class="form-check form-switch mb-3">
										<input class="form-check-input" type="checkbox"
											id="hasUsageLimit" onchange="toggleUsageLimit()"> 
										<label class="form-check-label" for="hasUsageLimit">
											<strong>Giới hạn số lượt sử dụng</strong>
										</label>
									</div>
								</div>

								<div class="col-md-6" id="usageLimitField"
									style="display: none;">
									<label for="usageLimit" class="form-label">Số lượt sử
										dụng tối đa</label> 
									<input type="number" class="form-control"
										id="usageLimit" th:field="*{usageLimit}" placeholder="0"
										min="1" value="0">
									<div class="form-text">Để 0 hoặc bỏ trống = không giới hạn</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Sidebar - Preview -->
				<div class="col-lg-4">
					<div class="card mb-4 sticky-top" style="top: 80px;">
						<div class="card-header bg-light">
							<h5 class="mb-0">
								<i class="bi bi-eye me-2"></i>Xem trước
							</h5>
						</div>
						<div class="card-body">
							<div class="alert alert-info mb-0">
								<div class="mb-3">
									<h6 class="mb-1" id="previewName">Tên khuyến mãi</h6>
									<small class="text-muted" id="previewDescription">Mô
										tả chương trình</small>
								</div>

								<div class="border-top pt-3">
									<div class="d-flex justify-content-between mb-2">
										<span class="text-muted">Mã:</span>
										<code class="fs-6" id="previewCode">---</code>
									</div>
									<div class="d-flex justify-content-between mb-2">
										<span class="text-muted">Loại:</span> 
										<span id="previewType">---</span>
									</div>
									<div class="d-flex justify-content-between mb-2">
										<span class="text-muted">Giảm:</span> 
										<strong id="previewDiscount">---</strong>
									</div>
									<div class="d-flex justify-content-between mb-2"
										id="previewMaxRow" style="display: none !important;">
										<span class="text-muted">Tối đa:</span> 
										<strong id="previewMax">---</strong>
									</div>
									<div class="d-flex justify-content-between mb-3">
										<span class="text-muted">Đơn tối thiểu:</span> 
										<strong id="previewMin">0đ</strong>
									</div>

									<div class="border-top pt-3">
										<small class="text-muted d-block mb-1"> 
											<i class="bi bi-calendar-event me-1"></i> 
											Từ: <span id="previewStart">---</span>
										</small> 
										<small class="text-muted d-block"> 
											<i class="bi bi-calendar-x me-1"></i> 
											Đến: <span id="previewEnd">---</span>
										</small>
									</div>

									<div class="border-top pt-3 mt-3" id="previewLimitRow"
										style="display: none;">
										<small class="text-muted"> 
											<i class="bi bi-hash me-1"></i>
											Giới hạn: <strong id="previewLimit">Không giới hạn</strong>
										</small>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Action Buttons -->
					<div class="card">
						<div class="card-body">
							<button type="submit" class="btn btn-primary w-100 mb-2">
								<i class="bi bi-check-circle me-1"></i> 
								<span th:text="${action == 'create' ? 'Tạo khuyến mãi' : 'Cập nhật khuyến mãi'}"></span>
							</button>
							<a href="/vendor/promotions" class="btn btn-outline-secondary w-100"> 
								<i class="bi bi-x-circle me-1"></i>Hủy bỏ
							</a>

							<div class="alert alert-warning mt-3 mb-0">
								<small> 
									<i class="bi bi-info-circle me-1"></i> 
									<strong>Lưu ý:</strong> Yêu cầu sẽ được gửi đến admin để phê duyệt trước khi khuyến mãi được kích hoạt.
								</small>
							</div>
						</div>
					</div>
				</div>
			</div>
		</form>

		<script>
			// Format number with thousand separators
			function formatNumber(num) {
				return new Intl.NumberFormat('vi-VN').format(num);
			}

			// Format datetime
			function formatDateTime(dateStr) {
				if (!dateStr) return '---';
				const date = new Date(dateStr);
				return date.toLocaleString('vi-VN', {
					day: '2-digit',
					month: '2-digit',
					year: 'numeric',
					hour: '2-digit',
					minute: '2-digit'
				});
			}

			// Toggle discount fields based on type
			function toggleDiscountFields() {
				const discountType = document.getElementById('discountType').value;
				const maxDiscountField = document.getElementById('maxDiscountField');
				const discountValueUnit = document.getElementById('discountValueUnit');
				const discountValueHelp = document.getElementById('discountValueHelp');
				const discountValue = document.getElementById('discountValue');

				if (discountType === 'PERCENTAGE') {
					maxDiscountField.style.display = 'block';
					discountValueUnit.textContent = '%';
					discountValueHelp.textContent = 'Nhập phần trăm giảm giá (0-100)';
					discountValue.max = 100;
					discountValue.placeholder = '0-100';
				} else if (discountType === 'FIXED') {
					maxDiscountField.style.display = 'none';
					discountValueUnit.textContent = 'VNĐ';
					discountValueHelp.textContent = 'Nhập số tiền giảm cố định';
					discountValue.max = '';
					discountValue.placeholder = '0';
					document.getElementById('maxDiscountAmount').value = '';
				}

				updatePreview();
			}

			// Toggle usage limit field
			function toggleUsageLimit() {
				const hasLimit = document.getElementById('hasUsageLimit').checked;
				const usageLimitField = document.getElementById('usageLimitField');
				const usageLimitInput = document.getElementById('usageLimit');

				if (hasLimit) {
					usageLimitField.style.display = 'block';
					usageLimitInput.required = true;
					usageLimitInput.min = 1;
				} else {
					usageLimitField.style.display = 'none';
					usageLimitInput.required = false;
					usageLimitInput.value = 0;
				}

				updatePreview();
			}

			// Update preview
			function updatePreview() {
				// Name and description
				const name = document.getElementById('promotionName').value || 'Tên khuyến mãi';
				const description = document.getElementById('description').value || 'Mô tả chương trình';
				document.getElementById('previewName').textContent = name;
				document.getElementById('previewDescription').textContent = description;

				// Promo code
				const code = document.getElementById('promoCode').value || '---';
				document.getElementById('previewCode').textContent = code.toUpperCase();

				// Discount type
				const type = document.getElementById('discountType').value;
				const typeText = type === 'PERCENTAGE' ? 'Phần trăm' : type === 'FIXED' ? 'Cố định' : '---';
				document.getElementById('previewType').textContent = typeText;

				// Discount value
				const value = parseFloat(document.getElementById('discountValue').value) || 0;
				let discountText = '---';
				if (type === 'PERCENTAGE') {
					discountText = value + '%';
				} else if (type === 'FIXED') {
					discountText = formatNumber(value) + 'đ';
				}
				document.getElementById('previewDiscount').textContent = discountText;

				// Max discount (only for percentage)
				const maxDiscountRow = document.getElementById('previewMaxRow');
				if (type === 'PERCENTAGE') {
					const maxDiscount = parseFloat(document.getElementById('maxDiscountAmount').value) || 0;
					document.getElementById('previewMax').textContent = formatNumber(maxDiscount) + 'đ';
					maxDiscountRow.style.display = 'flex';
				} else {
					maxDiscountRow.style.display = 'none';
				}

				// Min order value
				const minOrder = parseFloat(document.getElementById('minOrderValue').value) || 0;
				document.getElementById('previewMin').textContent = formatNumber(minOrder) + 'đ';

				// Dates
				const startDate = document.getElementById('startDate').value;
				const endDate = document.getElementById('endDate').value;
				document.getElementById('previewStart').textContent = formatDateTime(startDate);
				document.getElementById('previewEnd').textContent = formatDateTime(endDate);

				// Usage limit
				const hasLimit = document.getElementById('hasUsageLimit').checked;
				const limitRow = document.getElementById('previewLimitRow');
				if (hasLimit) {
					const limit = document.getElementById('usageLimit').value || 0;
					document.getElementById('previewLimit').textContent = limit > 0 ? formatNumber(limit) + ' lượt' : 'Không giới hạn';
					limitRow.style.display = 'block';
				} else {
					document.getElementById('previewLimit').textContent = 'Không giới hạn';
					limitRow.style.display = 'block';
				}
			}

			// Form validation
			document.getElementById('promotionForm').addEventListener('submit', function(e) {
				const discountType = document.getElementById('discountType').value;
				const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
				const startDate = new Date(document.getElementById('startDate').value);
				const endDate = new Date(document.getElementById('endDate').value);

				// Validate discount value
				if (discountType === 'PERCENTAGE') {
					if (discountValue < 0 || discountValue > 100) {
						e.preventDefault();
						alert('Giá trị giảm giá phần trăm phải từ 0-100%');
						return false;
					}
				} else if (discountType === 'FIXED') {
					if (discountValue <= 0) {
						e.preventDefault();
						alert('Giá trị giảm giá cố định phải lớn hơn 0');
						return false;
					}
				}

				// Validate dates
				if (endDate <= startDate) {
					e.preventDefault();
					alert('Ngày kết thúc phải sau ngày bắt đầu');
					return false;
				}

				// Validate promo code
				const promoCode = document.getElementById('promoCode').value;
				if (!/^[A-Z0-9]+$/.test(promoCode)) {
					e.preventDefault();
					alert('Mã giảm giá chỉ được chứa chữ cái in hoa và số');
					return false;
				}

				return true;
			});

			// Auto-uppercase promo code
			document.getElementById('promoCode').addEventListener('input', function(e) {
				e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
				updatePreview();
			});

			// Listen to all form inputs for preview update
			document.querySelectorAll('#promotionForm input, #promotionForm select, #promotionForm textarea').forEach(element => {
				element.addEventListener('input', updatePreview);
				element.addEventListener('change', updatePreview);
			});

			// Initialize on page load
			document.addEventListener('DOMContentLoaded', function() {
				const action = '[[${action}]]';
				const startDateInput = document.getElementById('startDate');
				const endDateInput = document.getElementById('endDate');
				
				// Set default dates if creating new
				if (action === 'create') {
					if (!startDateInput.value) {
						const now = new Date();
						now.setHours(0, 0, 0, 0);
						startDateInput.value = now.toISOString().slice(0, 16);
					}
					
					if (!endDateInput.value) {
						const endDate = new Date();
						endDate.setDate(endDate.getDate() + 30);
						endDate.setHours(23, 59, 0, 0);
						endDateInput.value = endDate.toISOString().slice(0, 16);
					}
				}
				// For edit mode, values should already be formatted by controller
				// But add fallback just in case
				else if (action === 'edit') {
					// Only format if value exists but not in correct format
					if (startDateInput.value && !startDateInput.value.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
						console.warn('Start date not in expected format:', startDateInput.value);
					}
					if (endDateInput.value && !endDateInput.value.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
						console.warn('End date not in expected format:', endDateInput.value);
					}
				}

				// Check if editing and has usage limit
				const usageLimit = parseInt(document.getElementById('usageLimit').value) || 0;
				if (usageLimit > 0) {
					document.getElementById('hasUsageLimit').checked = true;
					toggleUsageLimit();
				}

				// Initialize discount type fields
				toggleDiscountFields();
				
				// Initial preview update
				updatePreview();
			});
		</script>

	</div>
</body>
</html>