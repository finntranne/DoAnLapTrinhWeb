<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{vendor/layouts/vendor-layout}" lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý Doanh thu - Vendor | AloTra</title>

<th:block layout:fragment="head">
</th:block>

<style>
/* ... (keep existing CSS styles) ... */
.chart-container {
	position: relative;
	height: 400px; /* Adjust as needed */
	margin-bottom: 2rem;
}

.stats-card {
	transition: transform 0.2s, box-shadow 0.2s;
}

.stats-card:hover {
	transform: translateY(-5px);
	box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.revenue-icon {
	font-size: 2.5rem;
	opacity: 0.2;
	position: absolute;
	right: 15px;
	top: 15px;
}

.filter-section {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	border-radius: 10px;
	padding: 1.5rem;
	color: white;
	margin-bottom: 2rem;
}

.filter-section .form-label {
	color: white;
	font-weight: 500;
}

.filter-section .form-control {
	border: 1px solid rgba(255, 255, 255, 0.3);
	background: rgba(255, 255, 255, 0.9);
}

.filter-section .btn-primary {
	background: white;
	color: #667eea;
	border: none;
	font-weight: 600;
}

.filter-section .btn-outline-light {
	border: 1px solid rgba(255, 255, 255, 0.5);
	color: white;
}

.filter-section .btn-outline-light:hover {
	background: rgba(255, 255, 255, 0.2);
	border-color: white;
	color: white;
}

.date-info {
	background: rgba(255, 255, 255, 0.15);
	border-radius: 6px;
	padding: 0.5rem 1rem;
}

.table-revenue {
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
	border-radius: 8px;
	overflow: hidden;
}

.chart-tabs {
	border-bottom: 2px solid #e9ecef;
	margin-bottom: 1.5rem;
}

.chart-tab {
	padding: 0.75rem 1.5rem;
	cursor: pointer;
	border: none;
	background: transparent;
	color: #6c757d;
	font-weight: 500;
	position: relative;
	transition: color 0.3s;
}

.chart-tab:hover {
	color: #495057;
}

.chart-tab.active {
	color: #667eea;
}

.chart-tab.active::after {
	content: '';
	position: absolute;
	bottom: -2px;
	left: 0;
	right: 0;
	height: 2px;
	background: #667eea;
}

.date-range-buttons .btn {
	font-size: 0.85rem;
	padding: 0.3rem 0.6rem;
} /* Style for date range buttons */
</style>
</head>
<body>

	<div layout:fragment="content">

		<div
			class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
			<h1 class="h2">
				<i class="bi bi-graph-up-arrow me-2"></i>Quản lý Doanh thu
			</h1>
			<div>
				<button type="button" class="btn btn-success me-2"
					onclick="exportExcel()">
					<i class="bi bi-file-earmark-excel me-1"></i>Xuất Excel
				</button>
				<a th:href="@{/vendor/dashboard}" class="btn btn-outline-secondary">
					<i class="bi bi-arrow-left me-1"></i>Dashboard
				</a>
			</div>
		</div>

		<div th:if="${success}"
			class="alert alert-success alert-dismissible fade show" role="alert">...</div>
		<div th:if="${error}"
			class="alert alert-danger alert-dismissible fade show" role="alert">...</div>

		<div class="filter-section shadow-sm">
			<form id="filterForm" method="get" th:action="@{/vendor/revenue}">
				<div class="row g-3 align-items-end mb-3">
					<div class="col-md-4">
						<label for="startDate" class="form-label"><i
							class="bi bi-calendar-event me-1"></i>Từ ngày</label> <input
							type="datetime-local" class="form-control form-control-sm"
							id="startDate" name="startDate"
							th:value="${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
					</div>
					<div class="col-md-4">
						<label for="endDate" class="form-label"><i
							class="bi bi-calendar-event me-1"></i>Đến ngày</label> <input
							type="datetime-local" class="form-control form-control-sm"
							id="endDate" name="endDate"
							th:value="${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
					</div>
					<div class="col-md-4">
						<div class="row g-2">
							<div class="col-6">
								<button type="submit" class="btn btn-primary btn-sm w-100">
									<i class="bi bi-funnel me-1"></i>Lọc
								</button>
							</div>
							<div class="col-6">
								<button type="button" class="btn btn-outline-light btn-sm w-100"
									onclick="clearFilter()">
									<i class="bi bi-arrow-clockwise me-1"></i>Reset
								</button>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-12">
						<label class="form-label mb-1">Chọn nhanh:</label>
						<div class="btn-group btn-group-sm date-range-buttons flex-wrap"
							role="group">
							<button type="button" class="btn btn-outline-light"
								onclick="setAndSubmitDateRange('today')">Hôm nay</button>
							<button type="button" class="btn btn-outline-light"
								onclick="setAndSubmitDateRange('yesterday')">Hôm qua</button>
							<button type="button" class="btn btn-outline-light"
								onclick="setAndSubmitDateRange('last7days')">7 ngày qua</button>
							<button type="button" class="btn btn-outline-light"
								onclick="setAndSubmitDateRange('last30days')">30 ngày
								qua</button>
							<button type="button" class="btn btn-outline-light"
								onclick="setAndSubmitDateRange('thisMonth')">Tháng này</button>
							<button type="button" class="btn btn-outline-light"
								onclick="setAndSubmitDateRange('lastMonth')">Tháng
								trước</button>
						</div>
					</div>
				</div>
			</form>
			<div class="mt-3 date-info">
				<small class="d-flex align-items-center"><i
					class="bi bi-info-circle me-2"></i> <span
					th:if="${startDate != null and endDate != null}"> Đang hiển
						thị từ <strong class="mx-1"
						th:text="${#temporals.format(startDate, 'dd/MM/yyyy HH:mm')}"></strong>
						đến <strong class="mx-1"
						th:text="${#temporals.format(endDate, 'dd/MM/yyyy HH:mm')}"></strong>
				</span> <span th:if="${startDate == null or endDate == null}"> Đang
						hiển thị doanh thu <strong class="mx-1">1 tháng gần nhất</strong>
						(mặc định)
				</span> </small>
			</div>
		</div>

		<th:block
			th:with="
            totalOrderAmount=${#aggregates.sum(revenues.![orderAmount]) ?: T(java.math.BigDecimal).ZERO},
            totalCommission=${#aggregates.sum(revenues.![commissionAmount]) ?: T(java.math.BigDecimal).ZERO},
            totalNetRevenue=${#aggregates.sum(revenues.![netRevenue]) ?: T(java.math.BigDecimal).ZERO},
            totalOrders=${#aggregates.sum(revenues.![totalOrders]) ?: 0}">

			<div class="row g-4 mb-4">
				<div class="col-lg-3 col-md-6">
					<div
						class="card stats-card border-0 h-100 bg-primary bg-gradient text-white position-relative">
						<div class="card-body">
							<i class="bi bi-cart-check revenue-icon"></i>
							<h6 class="card-title text-white-50 mb-2">Tổng đơn hàng</h6>
							<p class="card-text fs-3 fw-bold mb-0" th:text="${totalOrders}">0</p>
						</div>
					</div>
				</div>
				<div class="col-lg-3 col-md-6">
					<div
						class="card stats-card border-0 h-100 bg-info bg-gradient text-white position-relative">
						<div class="card-body">
							<i class="bi bi-cash-stack revenue-icon"></i>
							<h6 class="card-title text-white-50 mb-2">Tổng Doanh thu
								(Gross)</h6>
							<p class="card-text fs-4 fw-bold mb-0"
								th:text="${#numbers.formatDecimal(totalOrderAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0
								₫</p>
						</div>
					</div>
				</div>
				<div class="col-lg-3 col-md-6">
					<div
						class="card stats-card border-0 h-100 bg-warning bg-gradient text-dark position-relative">
						<div class="card-body">
							<i class="bi bi-percent revenue-icon" style="opacity: 0.1;"></i>
							<h6 class="card-title text-dark-emphasis mb-2">Tổng Phí
								(Commission)</h6>
							<p class="card-text fs-4 fw-bold mb-0"
								th:text="${#numbers.formatDecimal(totalCommission, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0
								₫</p>
						</div>
					</div>
				</div>
				<div class="col-lg-3 col-md-6">
					<div
						class="card stats-card border-0 h-100 bg-success bg-gradient text-white position-relative">
						<div class="card-body">
							<i class="bi bi-wallet2 revenue-icon"></i>
							<h6 class="card-title text-white-50 mb-2">Thực nhận (Net)</h6>
							<p class="card-text fs-4 fw-bold mb-0"
								th:text="${#numbers.formatDecimal(totalNetRevenue, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0
								₫</p>
						</div>
					</div>
				</div>
			</div>
		</th:block>

		<div class="card mb-4 border-0 shadow-sm">
			<div class="card-header bg-white border-0 pt-4">
				<h5 class="card-title mb-0">
					<i class="bi bi-graph-up me-2"></i>Biểu đồ Doanh thu
				</h5>
			</div>
			<div class="card-body">
				<div th:if="${revenues == null or revenues.isEmpty()}"
					class="text-center text-muted py-5">
					<i class="bi bi-bar-chart-line"
						style="font-size: 3rem; opacity: 0.3;"></i>
					<p class="mt-2">Không có dữ liệu để vẽ biểu đồ.</p>
				</div>
				<div th:if="${revenues != null and !revenues.isEmpty()}">
					<div class="chart-tabs">
						<button class="chart-tab active"
							onclick="switchChart('line', event)">
							<i class="bi bi-graph-up me-1"></i>Đường
						</button>
						<button class="chart-tab" onclick="switchChart('bar', event)">
							<i class="bi bi-bar-chart-fill me-1"></i>Cột
						</button>
						<button class="chart-tab" onclick="switchChart('area', event)">
							<i class="bi bi-activity me-1"></i>Vùng
						</button>
					</div>
					<div class="chart-container">
						<canvas id="revenueChart"></canvas>
					</div>
				</div>
			</div>
		</div>

		<div class="card border-0 shadow-sm">
			<div class="card-body p-0">
				<div th:if="${revenues != null and !revenues.isEmpty()}"
					class="table-responsive">
					<table class="table table-hover align-middle mb-0 table-revenue">
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	<th:block layout:fragment="scripts">
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
		<script th:inline="javascript">
            // ===== CHART.JS CHECK =====
            console.log('Chart.js available:', typeof Chart !== 'undefined');
            if (typeof Chart !== 'undefined') {
                console.log('Chart.js version:', Chart.version);
            } else {
                 console.error('Chart.js library not loaded!');
            }

            // ===== GLOBAL VARIABLES =====
            var revenueChart = null;
            var currentChartType = 'line'; // Default type
            var revenuesData = []; // Global scope for data

            // ===== LOAD DATA FROM THYMELEAF =====
            /*[# th:if="${revenues != null and !revenues.isEmpty()}"]*/
            /*[# th:each="revenue : ${revenues}"]*/
            revenuesData.push({
                date: /*[[${#temporals.formatISO(revenue.date)}]]*/ null, // Use ISO format for JS Date parsing
                orderAmount: /*[[${revenue.orderAmount}]]*/ 0,
                commissionAmount: /*[[${revenue.commissionAmount}]]*/ 0,
                netRevenue: /*[[${revenue.netRevenue}]]*/ 0,
                totalOrders: /*[[${revenue.totalOrders}]]*/ 0
            });
            /*[/]*/
            /*[/]*/
            console.log('Revenue data loaded:', revenuesData.length, 'records');

            // ===== INITIALIZE CHART ON PAGE LOAD =====
            document.addEventListener('DOMContentLoaded', initializeChart);

            function initializeChart() {
                console.log('=== INITIALIZING CHART ===');
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded yet, cannot initialize.');
                    // Optionally display an error message
                    return;
                }
                const chartCanvas = document.getElementById('revenueChart');
                if (!chartCanvas) {
                    // This means the chart section wasn't rendered (no revenue data)
                    console.log('Canvas element "revenueChart" not found (likely no data).');
                    return;
                }
                const ctx = chartCanvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get 2D context for canvas!');
                    return;
                }

                if (revenuesData && revenuesData.length > 0) {
                    // Sort data by date ascending for the chart
                    revenuesData.sort((a, b) => new Date(a.date) - new Date(b.date));

                    const labels = revenuesData.map(r => {
                        try { return new Date(r.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }); }
                        catch (e) { console.warn('Date formatting error:', r.date); return 'N/A'; }
                    });
                    const grossData = revenuesData.map(r => parseFloat(r.orderAmount) || 0);
                    const commissionData = revenuesData.map(r => parseFloat(r.commissionAmount) || 0);
                    const netData = revenuesData.map(r => parseFloat(r.netRevenue) || 0);

                    console.log('Creating chart with', labels.length, 'data points');
                    createChart(labels, grossData, commissionData, netData, currentChartType); // Use default type
                } else {
                    console.log('No revenue data to display chart.');
                }
            }

            // ===== CREATE/UPDATE CHART FUNCTION =====
            function createChart(labels, grossData, commissionData, netData, type) {
                console.log('Attempting to create/update chart with type:', type);
                const chartCanvas = document.getElementById('revenueChart');
                if (!chartCanvas) { console.error('Canvas not found in createChart!'); return; }
                const ctx = chartCanvas.getContext('2d');
                 if (!ctx) { console.error('Canvas context not found in createChart!'); return; }


                if (revenueChart instanceof Chart) { // Check if it's a Chart.js instance
                    console.log('Destroying existing chart instance');
                    revenueChart.destroy();
                    revenueChart = null;
                }

                const isArea = type === 'area';
                const actualChartType = isArea ? 'line' : type;

                console.log(`Configuring new Chart: Type=${actualChartType}, IsArea=${isArea}`);

                try {
                    revenueChart = new Chart(ctx, {
                        type: actualChartType,
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Doanh thu (Gross)', data: grossData, borderColor: '#0d6efd', backgroundColor: isArea ? 'rgba(13, 110, 253, 0.1)' : '#0d6efd', borderWidth: 2, fill: isArea, tension: 0.3 },
                                { label: 'Phí (Commission)', data: commissionData, borderColor: '#ffc107', backgroundColor: isArea ? 'rgba(255, 193, 7, 0.1)' : '#ffc107', borderWidth: 2, fill: isArea, tension: 0.3 },
                                { label: 'Thực nhận (Net)', data: netData, borderColor: '#198754', backgroundColor: isArea ? 'rgba(25, 135, 84, 0.1)' : '#198754', borderWidth: 2, fill: isArea, tension: 0.3 }
                            ]
                        },
                        options: { // Keep existing options
                            responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 15, font: { size: 12 } } },
                                tooltip: { /* Keep existing tooltip config */
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed.y !== null) { label += new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' ₫'; }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: { /* Keep existing scales config */
                                y: { beginAtZero: true, ticks: { callback: value => new Intl.NumberFormat('vi-VN', { notation: 'compact' }).format(value) + ' ₫' }, grid: { color: 'rgba(0,0,0,0.05)' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                    console.log('Chart instance created successfully!');
                    currentChartType = type; // Update current type

                } catch (error) {
                    console.error('!!! Error creating Chart instance:', error);
                }
            }

            // ===== SWITCH CHART TYPE FUNCTION =====
            function switchChart(type, event) {
                console.log('Switching chart to type:', type);
                if (type === currentChartType || !revenuesData || revenuesData.length === 0) {
                    return;
                }
                // Re-process data as it's sorted now
                const labels = revenuesData.map(r => new Date(r.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
                const grossData = revenuesData.map(r => parseFloat(r.orderAmount) || 0);
                const commissionData = revenuesData.map(r => parseFloat(r.commissionAmount) || 0);
                const netData = revenuesData.map(r => parseFloat(r.netRevenue) || 0);

                createChart(labels, grossData, commissionData, netData, type);

                // Update active tab styling
                document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
                if (event && event.target) {
                    event.target.closest('.chart-tab').classList.add('active');
                }
            }

            // ===== FILTER FUNCTIONS =====
            function clearFilter() {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                window.location.href = '/vendor/revenue'; // Redirect to clear URL params
            }

            // Function to set dates and submit form for predefined ranges
            function setAndSubmitDateRange(rangeType) {
                const now = new Date();
                let start = new Date();
                let end = new Date(); // End date usually includes today up to now

                // Set end time to end of day for consistency unless 'today' or 'yesterday'
                end.setHours(23, 59, 59, 999);

                switch (rangeType) {
                    case 'today':
                        start.setHours(0, 0, 0, 0);
                        end = new Date(); // End is now for today
                        break;
                    case 'yesterday':
                        start.setDate(now.getDate() - 1);
                        start.setHours(0, 0, 0, 0);
                        end.setDate(now.getDate() - 1);
                        end.setHours(23, 59, 59, 999);
                        break;
                    case 'last7days':
                        start.setDate(now.getDate() - 6); // Includes today
                        start.setHours(0, 0, 0, 0);
                        // End remains today
                        break;
                    case 'last30days':
                        start.setDate(now.getDate() - 29); // Includes today
                        start.setHours(0, 0, 0, 0);
                        // End remains today
                        break;
                    case 'thisMonth':
                        start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
                        // End remains today (or end of month if preferred, but today is common)
                        end = new Date(); // End is now
                        break;
                    case 'lastMonth':
                        start = new Date(now.getFullYear(), now.getMonth() - 1, 1, 0, 0, 0, 0);
                        end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999); // Last day of previous month
                        break;
                    default:
                        console.error("Invalid date range type:", rangeType);
                        return;
                }

                 // Format dates as YYYY-MM-DDTHH:mm
                const formatDateTimeLocal = (date) => {
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                };

                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');

                if(startDateInput && endDateInput) {
                    startDateInput.value = formatDateTimeLocal(start);
                    endDateInput.value = formatDateTimeLocal(end);
                    console.log(`Set date range '${rangeType}': ${startDateInput.value} to ${endDateInput.value}`);

                    // Submit the form
                    document.getElementById('filterForm').submit();
                } else {
                    console.error("Date input fields not found!");
                }
            }
            
            function exportExcel() {
                const startDateVal = document.getElementById('startDate').value;
                const endDateVal = document.getElementById('endDate').value;
                let exportUrl = '/vendor/revenue/export';
                const params = [];

                if (startDateVal) {
                    params.push('startDate=' + encodeURIComponent(startDateVal));
                }
                if (endDateVal) {
                    params.push('endDate=' + encodeURIComponent(endDateVal));
                }

                if (params.length > 0) {
                    exportUrl += '?' + params.join('&');
                }

                console.log('Navigating to export URL:', exportUrl);
                window.location.href = exportUrl; // Trigger download
            }

		</script>

	</th:block>
</body>
</html>