<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{vendor/layouts/vendor-layout}" lang="vi">
<head>
<meta charset="UTF-8">
<title>Thêm nhân viên - Vendor | AloTra</title>
</head>
<body>

	<div layout:fragment="content">

		<!-- Page Header -->
		<div
			class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
			<h1 class="h2">
				<i class="bi bi-person-plus"></i> Thêm nhân viên
			</h1>
			<div class="btn-toolbar mb-2 mb-md-0">
				<a th:href="@{/vendor/staff}"
					class="btn btn-sm btn-outline-secondary"> <i
					class="bi bi-arrow-left"></i> Quay lại
				</a>
			</div>
		</div>

		<!-- Flash Messages -->
		<div th:if="${error}"
			class="alert alert-danger alert-dismissible fade show" role="alert">
			<i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>

		<div class="row justify-content-center">
			<div class="col-lg-8">
				<!-- Step 1: Search User -->
				<div class="card mb-4">
					<div class="card-header">
						<h5 class="mb-0">
							<i class="bi bi-search"></i> Bước 1: Tìm kiếm tài khoản
						</h5>
					</div>
					<div class="card-body">
						<p class="text-muted">Nhập email hoặc số điện thoại của người
							bạn muốn thêm làm nhân viên.</p>

						<div class="mb-3">
							<label class="form-label">Email hoặc Số điện thoại</label>
							<div class="input-group">
								<input type="text" id="searchInput" class="form-control"
									placeholder="Ví dụ: user@example.com hoặc 0987654321">
								<button type="button" class="btn btn-primary"
									onclick="searchUser()">
									<i class="bi bi-search"></i> Tìm kiếm
								</button>
							</div>
							<small class="text-muted"> Người dùng phải đã có tài
								khoản với vai trò "Khách hàng" </small>
						</div>

						<!-- Loading Spinner -->
						<div id="loadingSpinner" class="text-center d-none">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Đang tìm kiếm...</span>
							</div>
							<p class="text-muted mt-2">Đang tìm kiếm...</p>
						</div>

						<!-- Error Message -->
						<div id="searchError" class="alert alert-danger d-none"
							role="alert">
							<i class="bi bi-exclamation-triangle"></i> <span
								id="errorMessage"></span>
						</div>
					</div>
				</div>

				<!-- Step 2: User Information & Role Selection (Hidden by default) -->
				<div id="userInfoCard" class="card mb-4 d-none">
					<div class="card-header bg-success text-white">
						<h5 class="mb-0">
							<i class="bi bi-check-circle"></i> Bước 2: Xác nhận thông tin và
							phân quyền
						</h5>
					</div>
					<div class="card-body">
						<!-- User Info Display -->
						<div class="row mb-4">
							<div class="col-md-3 text-center">
								<img id="userAvatar" src="/assets/img/default-avatar.jpg"
									alt="Avatar" class="rounded-circle border"
									style="width: 100px; height: 100px; object-fit: cover;">
							</div>
							<div class="col-md-9">
								<h5 id="userFullName" class="mb-2"></h5>
								<div class="mb-1">
									<i class="bi bi-envelope text-muted"></i> <span id="userEmail"
										class="ms-2"></span>
								</div>
								<div>
									<i class="bi bi-telephone text-muted"></i> <span id="userPhone"
										class="ms-2"></span>
								</div>
							</div>
						</div>

						<!-- Role Selection Form -->
						<form id="addEmployeeForm" th:action="@{/vendor/staff/add}"
							method="post">
							<input type="hidden" name="userId" id="selectedUserId">

							<div class="mb-4">
								<label class="form-label fw-bold">Chọn vai trò <span
									class="text-danger">*</span></label>
								<div class="row">
									<div class="col-md-6">
										<div class="form-check">
											<input class="form-check-input" type="radio" name="roleId"
												id="roleStaff" value="5" required> <label
												class="form-check-label" for="roleStaff"> <i
												class="bi bi-person-badge text-info"></i> <strong>Nhân
													viên (Staff)</strong>
												<p class="text-muted small mb-0">Quản lý sản phẩm, đơn
													hàng và các nghiệp vụ cửa hàng</p>
											</label>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-check">
											<input class="form-check-input" type="radio" name="roleId"
												id="roleShipper" value="4" required> <label
												class="form-check-label" for="roleShipper"> <i
												class="bi bi-truck text-warning"></i> <strong>Shipper</strong>
												<p class="text-muted small mb-0">Giao hàng và cập nhật
													trạng thái đơn hàng</p>
											</label>
										</div>
									</div>
								</div>
							</div>

							<div class="d-flex justify-content-end gap-2">
								<button type="button" class="btn btn-secondary"
									onclick="resetSearch()">
									<i class="bi bi-arrow-counterclockwise"></i> Tìm kiếm khác
								</button>
								<button type="submit" class="btn btn-success">
									<i class="bi bi-check-lg"></i> Xác nhận thêm nhân viên
								</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script layout:fragment="scripts">
function searchUser() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    
    if (!searchTerm) {
        showError('Vui lòng nhập email hoặc số điện thoại');
        return;
    }
    
    // Show loading
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('searchError').classList.add('d-none');
    document.getElementById('userInfoCard').classList.add('d-none');
    
    // AJAX call to search user
    fetch('/vendor/staff/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ searchTerm: searchTerm })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        // Hide loading
        document.getElementById('loadingSpinner').classList.add('d-none');
        
        // Display user info
        displayUserInfo(data);
    })
    .catch(error => {
        // Hide loading
        document.getElementById('loadingSpinner').classList.add('d-none');
        
        // Show error
        showError(error.error || 'Có lỗi xảy ra khi tìm kiếm');
    });
}

function displayUserInfo(user) {
    // Populate user info
    document.getElementById('userAvatar').src = user.avatarURL || '/assets/img/default-avatar.jpg';
    document.getElementById('userFullName').textContent = user.fullName;
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('userPhone').textContent = user.phoneNumber || 'Chưa cập nhật';
    document.getElementById('selectedUserId').value = user.userId;
    
    // Show the card
    document.getElementById('userInfoCard').classList.remove('d-none');
    
    // Scroll to the card
    document.getElementById('userInfoCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('searchError').classList.remove('d-none');
}

function resetSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('userInfoCard').classList.add('d-none');
    document.getElementById('searchError').classList.add('d-none');
    document.getElementById('addEmployeeForm').reset();
}

// Allow search on Enter key
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchUser();
    }
});
</script>

</body>
</html>