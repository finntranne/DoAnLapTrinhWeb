<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{vendor/layouts/vendor-layout}" lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý sản phẩm - Vendor | AloTra</title>
</head>
<body>

	<div layout:fragment="content">

		<div
			class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
			<h1 class="h2">
				<i class="bi bi-box-seam"></i> Quản lý sản phẩm
			</h1>
			<a href="/vendor/products/create" class="btn btn-primary"> <i
				class="bi bi-plus-circle"></i> Thêm sản phẩm mới
			</a>
		</div>

		<div th:if="${success}"
			class="alert alert-success alert-dismissible fade show" role="alert">
			<i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"
				aria-label="Close"></button>
		</div>

		<div th:if="${warning}"
			class="alert alert-warning alert-dismissible fade show" role="alert">
			<i class="bi bi-exclamation-triangle"></i> <span th:text="${warning}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"
				aria-label="Close"></button>
		</div>
		<div th:if="${error}"
			class="alert alert-danger alert-dismissible fade show" role="alert">
			<i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"
				aria-label="Close"></button>
		</div>
		<div class="card mb-4">
			<div class="card-body">
				<form method="get" action="/vendor/products"
					class="row g-3 align-items-end">
					<div class="col-md-4 col-lg-3">
						<label class="form-label">Tìm kiếm</label> <input type="text"
							name="search" class="form-control" th:value="${search}"
							placeholder="Tên sản phẩm...">
					</div>
					<div class="col-md-3 col-lg-2">
						<label class="form-label">Trạng thái</label> <select name="status"
							class="form-select">
							<option value="">Tất cả</option>
							<option value="1" th:selected="${status != null and status == 1}">Đang
								hoạt động</option>
							<option value="0" th:selected="${status != null and status == 0}">Không
								hoạt động</option>
						</select>
					</div>
					<div class="col-md-3 col-lg-3">
						<label for="categoryId" class="form-label">Danh mục</label> <select
							class="form-select" id="categoryId" name="categoryId">
							<option value="">-- Tất cả danh mục --</option>
							<option th:each="category : ${categories}"
								th:value="${category.categoryID}"
								th:text="${category.categoryName}"
								th:selected="${categoryId != null and category.categoryID == categoryId}">
							</option>
						</select>
					</div>
					<div class="col-md-2 col-lg-4 d-flex">
						<button type="submit" class="btn btn-primary me-2">
							<i class="bi bi-search"></i> Lọc
						</button>
						<a th:href="@{/vendor/products}" class="btn btn-outline-secondary">
							<i class="bi bi-arrow-clockwise"></i> Đặt lại
						</a>
					</div>
				</form>
			</div>
		</div>

		<div class="card">
			<div class="card-header">
				<h5 class="card-title mb-0">
					<i class="bi bi-list-ul me-2"></i>Danh sách sản phẩm
				</h5>
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover align-middle">
						<thead class="table-light">
							<tr>
								<th style="width: 80px;">Hình ảnh</th>
								<th>Tên sản phẩm</th>
								<th>Giá</th>
								<th>Đã bán</th>
								<th>Đánh giá</th>
								<th>Lượt xem</th>
								<th>Trạng thái</th>
								<th>Phê duyệt</th>
								<th style="width: 150px;">Thao tác</th>
							</tr>
						</thead>
						<tbody>
							<tr th:if="${products.isEmpty()}">
								<td colspan="9" class="text-center text-muted py-5"><i
									class="bi bi-inbox" style="font-size: 3rem;"></i>
									<p class="mt-2">Chưa có sản phẩm nào</p></td>
							</tr>
							<tr th:each="product : ${products}">
								<td><img th:src="${product.primaryImageUrl}"
									alt="Product Image" class="img-thumbnail"
									style="width: 60px; height: 60px; object-fit: cover;"></td>
								<td><strong th:text="${product.productName}"></strong></td>
								<td><span
									th:text="${#numbers.formatDecimal(product.minPrice, 0, 'COMMA', 0, 'POINT')}"></span>đ
								</td>
								<td><span class="badge bg-info"
									th:text="${product.soldCount}"></span></td>
								<td><i class="bi bi-star-fill text-warning"></i> <span
									th:text="${#numbers.formatDecimal(product.averageRating, 1, 2)}"></span>
									<small class="text-muted">(<span
										th:text="${product.totalReviews}"></span>)
								</small></td>
								<td><i class="bi bi-eye"></i> <span
									th:text="${product.viewCount}"></span></td>
								<td><span class="badge"
									th:classappend="${product.status == 'Đang hoạt động' ? 'bg-success' : 'bg-secondary'}"
									th:text="${product.status}"></span></td>
								<td><span class="badge bg-warning text-dark"
									th:if="${product.approvalStatus != null and #strings.startsWith(product.approvalStatus, 'Đang chờ:')}"
									th:text="${product.approvalStatus}"> </span> <span
									class="badge bg-danger"
									th:if="${product.approvalStatus != null and #strings.startsWith(product.approvalStatus, 'Bị từ chối:')}"
									th:text="${product.approvalStatus}"> </span> <span
									class="badge bg-success"
									th:if="${product.approvalStatus == null}"> Đã duyệt </span></td>
								<td>
									<div class="btn-group" role="group">
										<a
											th:href="@{/vendor/products/edit/{id}(id=${product.productId})}"
											class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
											<i class="bi bi-pencil"></i>
										</a>
										<button type="button"
											class="btn btn-sm btn-outline-danger btn-delete"
											th:data-id="${product.productId}"
											th:data-name="${product.productName}" title="Xóa">
											<i class="bi bi-trash"></i>
										</button>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>

				<nav th:if="${totalPages > 1}" aria-label="Page navigation">
					<ul class="pagination justify-content-center">
						<li class="page-item"
							th:classappend="${currentPage == 0 ? 'disabled' : ''}"><a
							class="page-link"
							th:href="@{/vendor/products(page=${currentPage - 1}, status=${status}, search=${search})}">
								Trước </a></li>

						<li class="page-item"
							th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
							th:classappend="${i == currentPage ? 'active' : ''}"><a
							class="page-link"
							th:href="@{/vendor/products(page=${i}, status=${status}, search=${search})}"
							th:text="${i + 1}"></a></li>

						<li class="page-item"
							th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
							<a class="page-link"
							th:href="@{/vendor/products(page=${currentPage + 1}, status=${status}, search=${search})}">
								Sau </a>
						</li>
					</ul>
				</nav>
			</div>
		</div>

		<div class="modal fade" id="deleteModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Xác nhận xóa sản phẩm</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<p>
							Bạn có chắc muốn gửi yêu cầu xóa sản phẩm <strong
								id="productNameToDelete"></strong>?
						</p>
						<p class="text-warning">
							<i class="bi bi-exclamation-triangle"></i> Yêu cầu này cần được
							phê duyệt bởi Admin.
						</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Hủy</button>
						<form id="deleteForm" method="post">
							<button type="submit" class="btn btn-danger">Xác nhận
								xóa</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<script>
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        const productName = this.getAttribute('data-name');
                        confirmDelete(productId, productName);
                    });
                });
            });
    
            function confirmDelete(productId, productName) {
                document.getElementById('productNameToDelete').textContent = productName;
                document.getElementById('deleteForm').action = '/vendor/products/delete/' + productId;
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            }
        </script>

	</div>
</body>
</html>