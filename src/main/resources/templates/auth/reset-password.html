<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" th:href="@{/css/style.css}">
<title>ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u - AloTra</title>
<style>
body {
	margin: 0;
	padding: 0;
	font-family: 'Montserrat', sans-serif;
	background: linear-gradient(to right, #2da0a8, #1e7d85);
	min-height: 100vh;
	display: flex;
	align-items: center;
	justify-content: center;
}

.reset-container {
	background: white;
	border-radius: 30px;
	box-shadow: 0 5px 15px rgba(0, 0, 0, 0.35);
	width: 450px;
	max-width: 95%;
	padding: 40px;
	box-sizing: border-box;
}

h1 {
	font-size: 28px;
	color: #333;
	margin-bottom: 10px;
	text-align: center;
}

.masked-email-box {
	background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
	border-left: 4px solid #2da0a8;
	padding: 15px 20px;
	margin: 20px 0;
	border-radius: 8px;
	text-align: center;
}

.masked-email-label {
	font-size: 13px;
	color: #666;
	margin-bottom: 5px;
	font-weight: normal;
}

.masked-email-value {
	font-size: 16px;
	color: #2da0a8;
	font-weight: bold;
	letter-spacing: 0.5px;
}

.password-requirements {
	background: #f8f9fa;
	border: 1px solid #dee2e6;
	border-radius: 5px;
	padding: 12px 15px;
	margin: 15px 0;
	font-size: 13px;
}

.password-requirements ul {
	margin: 8px 0 0 20px;
	padding: 0;
	color: #666;
}

.password-requirements li {
	margin: 5px 0;
}

.password-requirements strong {
	color: #333;
}

.input-group {
	position: relative;
	margin-bottom: 20px;
}

.input-group input {
	width: 100%;
	padding: 12px 15px;
	border: 1px solid #ccc;
	border-radius: 8px;
	font-size: 14px;
	box-sizing: border-box;
	outline: none;
	transition: border-color 0.3s;
}

.input-group input:focus {
	border-color: #2da0a8;
}

.error-message {
	color: #e74c3c;
	font-size: 12px;
	margin-top: 5px;
	display: none;
}

#resetSubmitBtn {
	width: 100%;
	padding: 15px;
	background: linear-gradient(to right, #2da0a8, #1e7d85);
	color: white;
	border: none;
	border-radius: 8px;
	font-size: 16px;
	font-weight: bold;
	cursor: pointer;
	margin-top: 10px;
	transition: opacity 0.3s;
}

#resetSubmitBtn:hover {
	opacity: 0.9;
}

#resetSubmitBtn:disabled {
	background: #ccc;
	cursor: not-allowed;
	opacity: 0.6;
}

.back-to-login {
	display: block;
	text-align: center;
	margin-top: 20px;
	color: #2da0a8;
	text-decoration: none;
	font-size: 14px;
}

.back-to-login:hover {
	text-decoration: underline;
}

#reset-error-message {
	background: #fee;
	color: red;
	padding: 10px;
	border-radius: 5px;
	margin-bottom: 15px;
	text-align: center;
	display: none;
}
</style>
</head>
<body>
	<div class="reset-container">
		<form id="resetPasswordForm">
			<h1>üîê ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u</h1>

			<!-- Hi·ªÉn th·ªã email ƒë√£ mask -->
			<div class="masked-email-box" th:if="${maskedEmail}">
				<div class="masked-email-label">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u cho t√†i kho·∫£n</div>
				<div class="masked-email-value" th:text="${maskedEmail}"
					th:title="${fullEmail}">n***m@gmail.com</div>
			</div>

			<!-- Th√¥ng b√°o l·ªói chung -->
			<div id="reset-error-message"></div>

			<!-- Hidden token field -->
			<input type="hidden" id="resetToken" name="token" th:value="${token}" />

			<!-- Password requirements info -->
			<div class="password-requirements">
				<strong>üìã Y√™u c·∫ßu m·∫≠t kh·∫©u:</strong>
				<ul>
					<li>T·ªëi thi·ªÉu <strong>6 k√Ω t·ª±</strong></li>
					<li>Kh√¥ng ch·ª©a kho·∫£ng tr·∫Øng</li>
					<li>N√™n k·∫øt h·ª£p ch·ªØ v√† s·ªë ƒë·ªÉ b·∫£o m·∫≠t t·ªët h∆°n</li>
				</ul>
			</div>

			<div class="input-group">
				<input type="password" id="newPassword" name="newPassword"
					placeholder="M·∫≠t kh·∫©u m·ªõi (√≠t nh·∫•t 6 k√Ω t·ª±)" required minlength="6" />
				<span class="error-message" id="reset-newPassword-error"></span>
			</div>

			<div class="input-group">
				<input type="password" id="confirmPassword" name="confirmPassword"
					placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi" required minlength="6" /> <span
					class="error-message" id="reset-confirmPassword-error"></span>
			</div>

			<button type="submit" id="resetSubmitBtn">X√°c nh·∫≠n ƒë·∫∑t l·∫°i</button>

			<a th:href="@{/login}" class="back-to-login">‚Üê Quay l·∫°i ƒêƒÉng nh·∫≠p</a>
		</form>
	</div>

	<script>
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById("resetPasswordForm");
            const submitBtn = document.getElementById("resetSubmitBtn");
            const errorMessage = document.getElementById("reset-error-message");
            
            const tokenInput = document.getElementById("resetToken");
            const newPasswordInput = document.getElementById("newPassword");
            const confirmPasswordInput = document.getElementById("confirmPassword");
            
            const newPassError = document.getElementById("reset-newPassword-error");
            const confirmPassError = document.getElementById("reset-confirmPassword-error");

            // Clear errors on input
            newPasswordInput.addEventListener('input', () => {
                newPassError.style.display = 'none';
                errorMessage.style.display = 'none';
            });
            
            confirmPasswordInput.addEventListener('input', () => {
                confirmPassError.style.display = 'none';
                errorMessage.style.display = 'none';
            });

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                
                // Clear previous errors
                errorMessage.style.display = 'none';
                newPassError.style.display = 'none';
                confirmPassError.style.display = 'none';
                
                submitBtn.disabled = true;
                submitBtn.textContent = "ƒêang x·ª≠ l√Ω...";
                
                const token = tokenInput.value;
                const newPassword = newPasswordInput.value.trim();
                const confirmPassword = confirmPasswordInput.value.trim();

                // Client-side validation
                if (newPassword.length < 6) {
                    newPassError.textContent = "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!";
                    newPassError.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = "X√°c nh·∫≠n ƒë·∫∑t l·∫°i";
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    confirmPassError.textContent = "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!";
                    confirmPassError.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = "X√°c nh·∫≠n ƒë·∫∑t l·∫°i";
                    return;
                }

                try {
                    const response = await fetch("/api/auth/reset-password", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ token, newPassword, confirmPassword })
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        // Hi·ªÉn th·ªã l·ªói t·ª´ server
                        if (result.errors) {
                            if (result.errors.newPassword) {
                                newPassError.textContent = result.errors.newPassword;
                                newPassError.style.display = 'block';
                            }
                            if (result.errors.confirmPassword) {
                                confirmPassError.textContent = result.errors.confirmPassword;
                                confirmPassError.style.display = 'block';
                            }
                            if (result.errors.token) {
                                errorMessage.textContent = result.errors.token;
                                errorMessage.style.display = 'block';
                            }
                        } else {
                            errorMessage.textContent = result.message || "C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.";
                            errorMessage.style.display = 'block';
                        }
                        
                        submitBtn.disabled = false;
                        submitBtn.textContent = "X√°c nh·∫≠n ƒë·∫∑t l·∫°i";
                        return;
                    }

                    // Th√†nh c√¥ng
                    alert("‚úÖ " + (result.message || "ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng!"));
                    window.location.href = "/login";

                } catch (error) {
                    console.error("L·ªói khi reset password:", error);
                    errorMessage.textContent = "ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.";
                    errorMessage.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = "X√°c nh·∫≠n ƒë·∫∑t l·∫°i";
                }
            });
        });
    </script>
</body>
</html>